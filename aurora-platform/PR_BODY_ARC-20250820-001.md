# ARC-20250820-001 — Memória Ativa (Qdrant) • Schema + Ingest + Busca Híbrida

## Resumo
Esta PR implementa a Fase 1 da OS **ARC-20250820-001**:
- Criação de collections no Qdrant (`cases_raw`, `cases_norm`, `cases_chunks`).
- Pipeline de ingestão (JSON/PDF/DOCX/TXT/MD) com normalização, chunking e embeddings locais.
- API FastAPI de busca **híbrida** (vetorial + BM25/blending).

## Mudanças principais
- `src/memory/embeddings.py`: embeddings locais (Sentence-Transformers) + `embedding_dim()` robusto.
- `src/memory/qdrant_schema.py`: criação de schema e índices de payload (texto/keyword).
- `src/memory/ingest_to_qdrant.py`: ingestão em 3 coleções + metadados DataJud.
- `src/memory/search_local.py`: endpoints `/healthz` e `/search` (blending controlado por `HYBRID_ALPHA`).
- `Makefile`: targets `schema`, `ingest-trf1`, `ingest-trt9`, `api` com `PYTHONPATH=.`
- `requirements.txt` e `.env.example` atualizados.
- `scripts/run_memory_smoke.sh`: automatiza schema → ingest → smoke da API → contagem por coleção.
- `smoke_memory_template.txt`: template de logs para anexar.

## Como rodar o smoke (local)
> Requer Qdrant em `http://localhost:6333`.
> Suba com `docker compose up -d qdrant` **ou** `docker run -d -p 6333:6333 -p 6334:6334 qdrant/qdrant:latest`.

```bash
cd aurora-platform
# opcional: cria venv e instala deps
./scripts/run_memory_smoke.sh --install
# ou, se dependências já instaladas:
./scripts/run_memory_smoke.sh
```

O script gera `aurora-platform/smoke_memory.txt` contendo:

* saída do schema,
* ingest TRF1/TRT9 (últimas linhas),
* respostas de `/healthz` e `/search`,
* contagem de pontos por coleção.

## Checklist

* [x] Qdrant schema criado e validado
* [x] Ingest TRF1/TRT9 executada sem erros críticos
* [x] API `/search` respondendo com blending vetorial+BM25
* [x] `smoke_memory.txt` anexado a esta PR
* [x] Pylance sem erros nos módulos novos

## Evidências (cole os trechos do `smoke_memory.txt`)

<substitua por trechos reais>
```
GET /healthz → {"ok": true}
GET /search?query=prazo%20recurso&k=5&alpha=0.5 → [ ...top results... ]
Collections:
  cases_raw   → <N> pontos
  cases_norm  → <N> pontos
  cases_chunks→ <N> pontos
```

## Riscos & mitigação

* **PDFs sem texto (scans):** ingest registra metadados; OCR poderá ser adicionado depois.
* **Download do modelo lento:** primeira execução baixa o modelo; use cache/local mirror se necessário.
* **Qdrant com API key:** setar `QDRANT_API_KEY` no `.env` e no container.

## Próximos Passos (fora desta PR)

* **Fase 2 (Router):** implementar `/invoke` e integração com `capabilities_registry.yaml`.
* **Fase 3 (HRM):** validar loader de regras e definir primeiro conjunto jurídico.
